<!doctype html>
<html lang="ro">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_brand_name }} - {{ app_product_name }} - V {{ app_version }}</title>
    <link rel="icon" href="{{ request.url_for('assets', path='app-icon.ico') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='style.css') }}" />
  </head>
  <body data-root-path="{{ root_path }}">
    <main class="container" aria-labelledby="page-title">
      <header class="brand">
        <p class="kicker">{{ app_brand_name }}</p>
        <h1 id="page-title" class="title">{{ app_product_name }}</h1>
        <p class="subtitle">DescarcÄƒ video (MP4) sau audio (MP3) dintr-un link â€” cu preview È™i status Ã®n timp real.</p>
      </header>

      <form class="card" action="{{ root_path }}/download" method="post">
        <div class="field">
          <label for="url">Link (URL)</label>
          <input
            id="url"
            name="url"
            type="url"
            inputmode="url"
            placeholder="https://..."
            required
            autocomplete="off"
          />
        </div>

        <section id="preview" class="preview hidden" aria-live="polite" aria-atomic="true">
          <div class="preview-media">
            <img id="previewThumb" class="preview-thumb hidden" alt="" loading="lazy" />
          </div>
          <div class="preview-body">
            <p class="preview-kicker" id="previewSource"></p>
            <h3 class="preview-title" id="previewTitle"></h3>
            <p class="preview-meta" id="previewMeta"></p>
            <p class="preview-desc" id="previewDesc"></p>
            <p class="preview-url">
              <a id="previewLink" href="#" target="_blank" rel="noreferrer">Deschide Ã®n platformÄƒ</a>
            </p>
            <p class="preview-error hidden" id="previewError"></p>
          </div>
        </section>

        <fieldset class="field" aria-labelledby="type-legend">
          <legend id="type-legend">Ce vrei sÄƒ descarci?</legend>

          <div class="radio-row">
            <input id="type-video" name="download_type" type="radio" value="video" checked />
            <label for="type-video">Video (MP4)</label>
          </div>

          <div class="radio-row">
            <input id="type-audio" name="download_type" type="radio" value="audio" />
            <label for="type-audio">Audio (MP3)</label>
          </div>
        </fieldset>

        <div class="field" id="audioFormatField">
          <label for="audio_format">Format audio</label>
          <select id="audio_format" name="audio_format">
            <option value="mp3" selected>MP3 (recomandat)</option>
            <option value="original">Original (fÄƒrÄƒ conversie)</option>
          </select>
          <p class="hint">DacÄƒ MP3 e selectat, e nevoie de FFmpeg.</p>
        </div>

        <button type="submit" class="btn btn-primary">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 3v10m0 0l4-4m-4 4l-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </span>
          DescarcÄƒ
        </button>

        <p class="hint" role="note">Pentru unele clipuri (private/age/geo), poate fi nevoie de cookies.</p>
      </form>

      <section class="card" aria-labelledby="help-title">
        <h2 id="help-title">Sfaturi rapide</h2>
        <ul>
          <li>DacÄƒ un clip este privat / necesitÄƒ login, e posibil sÄƒ nu meargÄƒ fÄƒrÄƒ cookies.</li>
          <li>Unele platforme blocheazÄƒ frecvent; Ã®ncearcÄƒ alt link sau alt format.</li>
        </ul>
      </section>

      <section class="card" aria-labelledby="about-title">
        <h2 id="about-title">ğŸ¬ {{ app_product_name }}</h2>
        <p class="muted">SoluÈ›ia completÄƒ pentru descÄƒrcarea conÈ›inutului audio-video de pe platformele tale preferate!</p>

        <h3 class="h3">âœ¨ Caracteristici principale</h3>
        <ul class="feature-list">
          <li>DescÄƒrcare video Ã®n calitate HD/Full HD/4K (MP4) â€” dacÄƒ sursa oferÄƒ aceste variante.</li>
          <li>Conversie audio: MP3 (cu FFmpeg) sau pÄƒstrare Ã®n format â€Originalâ€ (fÄƒrÄƒ conversie).</li>
          <li>Multi-platformÄƒ: YouTube, Facebook, TikTok, Instagram, X/Twitter, Vimeo È™i multe altele (prin yt-dlp).</li>
          <li>Preview Ã®naintea descÄƒrcÄƒrii â€” vezi exact ce salvezi.</li>
          <li>Coada de descÄƒrcÄƒri + progres live; suportÄƒ mai multe joburi (2 Ã®n paralel).</li>
          <li>Playlist-uri: dacÄƒ linkul este un playlist, yt-dlp poate descÄƒrca mai multe elemente (Ã®n funcÈ›ie de platformÄƒ).</li>
        </ul>

        <h3 class="h3">ğŸš€ De ce sÄƒ alegi {{ app_product_name }}?</h3>
        <ul class="feature-list">
          <li>âš¡ PerformanÈ›Äƒ superioarÄƒ â€” optimizat pentru uz local È™i pornire rapidÄƒ.</li>
          <li>ğŸ¯ Calitate pÄƒstratÄƒ â€” descarcÄƒ varianta disponibilÄƒ de la sursÄƒ.</li>
          <li>ğŸ”’ Sigur È™i privat â€” fÄƒrÄƒ tracking, fÄƒrÄƒ reclame intruzive; ruleazÄƒ pe PC-ul tÄƒu.</li>
          <li>ğŸ¨ InterfaÈ›Äƒ modernÄƒ â€” design intuitiv È™i uÈ™or de utilizat.</li>
        </ul>

        <p class="muted">Un produs dezvoltat de {{ app_brand_name }}. DescarcÄƒ acum È™i bucurÄƒ-te de conÈ›inutul tÄƒu preferat offline, oricÃ¢nd È™i oriunde!</p>
      </section>

      <footer class="footer" aria-label="Brand">
        <div class="footer-left">
          <img
            class="footer-logo"
            src="{{ request.url_for('assets', path='img/vixflotech/icon-vixflo.png') }}"
            alt="{{ app_brand_name }}"
            loading="lazy"
          />
          <div class="footer-lines">
            <p class="footer-line1">
              <span class="footer-brand">{{ app_brand_name }}</span>
            </p>
            <p class="footer-line2">
              <span class="footer-app">{{ app_product_name }}</span>
              <span class="footer-sep">â€¢</span>
              <span class="footer-version">V {{ app_version }}</span>
            </p>
          </div>
        </div>
      </footer>
    </main>

    <script>
      const rootPath = document.body.dataset.rootPath || '';
      const urlInput = document.getElementById('url');

      const previewEl = document.getElementById('preview');
      const previewThumb = document.getElementById('previewThumb');
      const previewTitle = document.getElementById('previewTitle');
      const previewMeta = document.getElementById('previewMeta');
      const previewSource = document.getElementById('previewSource');
      const previewLink = document.getElementById('previewLink');
      const previewError = document.getElementById('previewError');
      const previewDesc = document.getElementById('previewDesc');

      const audioFormatField = document.getElementById('audioFormatField');
      const typeVideo = document.getElementById('type-video');
      const typeAudio = document.getElementById('type-audio');

      function setAudioFieldVisibility() {
        audioFormatField.style.display = typeAudio.checked ? 'block' : 'none';
      }

      typeVideo.addEventListener('change', setAudioFieldVisibility);
      typeAudio.addEventListener('change', setAudioFieldVisibility);
      setAudioFieldVisibility();

      let inflight = null;
      let timer = null;
      let lastValue = '';

      function resetPreview() {
        previewEl.classList.add('hidden');
        previewError.classList.add('hidden');
        previewError.textContent = '';
        previewThumb.removeAttribute('src');
        previewThumb.classList.add('hidden');
        previewTitle.textContent = '';
        previewMeta.textContent = '';
        previewDesc.textContent = '';
        previewSource.textContent = '';
        previewLink.href = '#';
      }

      async function fetchPreview(url) {
        if (!url) return;
        if (inflight) inflight.abort();
        const controller = new AbortController();
        inflight = controller;

        try {
          const res = await fetch(`${rootPath}/api/preview?url=${encodeURIComponent(url)}`, {
            signal: controller.signal,
          });
          const data = await res.json();

          previewEl.classList.remove('hidden');

          if (!data.ok) {
            previewThumb.classList.add('hidden');
            previewTitle.textContent = 'Preview indisponibil';
            previewMeta.textContent = '';
            previewDesc.textContent = '';
            previewSource.textContent = '';
            previewError.classList.remove('hidden');
            previewError.textContent = data.error || 'Nu am putut prelua informaÈ›iile.';
            return;
          }

          previewError.classList.add('hidden');
          if (data.warning) {
            previewError.classList.remove('hidden');
            previewError.textContent = String(data.warning);
          }
          const title = data.title || 'FÄƒrÄƒ titlu';
          previewTitle.textContent = title;

          const parts = [];
          if (data.uploader) parts.push(data.uploader);
          if (data.duration_text) parts.push(data.duration_text);
          previewMeta.textContent = parts.join(' â€¢ ');

          const desc = (data.description || '').trim();
          previewDesc.textContent = desc ? (desc.length > 240 ? `${desc.slice(0, 240)}â€¦` : desc) : '';

          previewSource.textContent = data.extractor ? String(data.extractor).toUpperCase() : '';
          previewLink.href = data.webpage_url || data.url || '#';

          if (data.thumbnail) {
            previewThumb.src = data.thumbnail;
            previewThumb.classList.remove('hidden');
            previewThumb.alt = title;
          } else {
            previewThumb.classList.add('hidden');
          }
        } catch (e) {
          if (String(e).includes('AbortError')) return;
          previewEl.classList.remove('hidden');
          previewError.classList.remove('hidden');
          previewError.textContent = 'Eroare de reÈ›ea la preview.';
        }
      }

      function schedule() {
        const v = urlInput.value.trim();
        if (v === lastValue) return;
        lastValue = v;

        if (!v || v.length < 8) {
          resetPreview();
          return;
        }

        if (timer) clearTimeout(timer);
        timer = setTimeout(() => fetchPreview(v), 500);
      }

      urlInput.addEventListener('input', schedule);
      urlInput.addEventListener('blur', schedule);
    </script>
  </body>
</html>
